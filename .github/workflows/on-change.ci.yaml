name: OnChange
on:
    push:
        branches:
            - main
    pull_request:
        types: [opened, synchronize, reopened]

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: 24
    ARTIFACT_RETENTION_DAYS: 2

jobs:
    setup:
        name: Setup Dependencies
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  lfs: true

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Cache Node Modules
              id: node-modules-cache
              uses: actions/cache@v4
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Install Dependencies
              if: steps.node-modules-cache.outputs.cache-hit != 'true'
              run: npm ci

    build:
        name: Build
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: setup
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Restore Node Modules Cache
              uses: actions/cache/restore@v4
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Build
              run: npm run build

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-output
                  path: dist/
                  retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
                  if-no-files-found: error

    lint:
        name: Lint
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: setup
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Restore Node Modules Cache
              uses: actions/cache/restore@v4
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Lint
              run: npm run lint

    test:
        name: Test - ${{ matrix.type }}
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: setup
        strategy:
            matrix:
                include:
                    - type: unit
                      script: test:unit
                      coverage-path: coverage/unit
                      artifact-name: coverage-unit
                    - type: unit-visual
                      script: test:unit:visual
                      coverage-path: coverage/unit-visual
                      artifact-name: coverage-unit-visual
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Restore Node Modules Cache
              uses: actions/cache/restore@v4
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Cache Playwright Browsers
              id: playwright-cache
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-playwright-

            - name: Install Playwright Browsers
              if: steps.playwright-cache.outputs.cache-hit != 'true'
              run: npx playwright install --with-deps

            - name: Install Playwright System Dependencies
              if: steps.playwright-cache.outputs.cache-hit == 'true'
              run: npx playwright install-deps

            - name: Run Tests
              run: npm run ${{ matrix.script }}

            - name: Upload Coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: ${{ matrix.artifact-name }}
                  path: ${{ matrix.coverage-path }}/
                  retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

            - name: Upload Visual Test Screenshots
              uses: actions/upload-artifact@v4
              if: failure() && matrix.type == 'unit-visual'
              with:
                  name: visual-test-failures
                  path: src/**/__screenshots__/
                  retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

    architecture:
        name: Architecture
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: [setup, test]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  lfs: true

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Restore Node Modules Cache
              uses: actions/cache/restore@v4
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Install Graphviz
              run: sudo apt-get update && sudo apt-get install -y graphviz

            - name: Download Unit Coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-unit
                  path: coverage/unit/

            - name: Download Visual Coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-unit-visual
                  path: coverage/unit-visual/

            - name: Analyze Dependencies
              run: npm run analyze:deps

            - name: Generate Module Dependencies Graph
              run: npm run visualize:modules

            - name: Generate Architecture Layers Graph
              run: npm run visualize:layers

            - name: Check Dependency Graphs Are Up-to-Date
              run: |
                  if ! git diff --exit-code docs/module-dependencies.svg docs/architecture-layers.svg; then
                    echo "::error title=Outdated Dependency Graphs::Dependency graphs are out of date! Run 'npm run visualize:modules' and 'npm run visualize:layers' and commit the changes."
                    exit 1
                  fi

            - name: Generate Architecture Metrics
              run: npm run docs:metrics

            - name: Check Architecture Documentation Is Up-to-Date
              run: |
                  if ! git diff --exit-code docs/ARCHITECTURE.md; then
                    echo "::error title=Outdated Architecture Docs::Architecture metrics are out of date! Run 'npm run docs:metrics' and commit the changes."
                    exit 1
                  fi

            - name: Report Results
              if: always()
              run: |
                  echo "## Architecture Validation" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "✅ No circular dependencies detected" >> $GITHUB_STEP_SUMMARY
                  echo "✅ Dependency graphs are up-to-date" >> $GITHUB_STEP_SUMMARY
                  echo "✅ Architecture documentation is current" >> $GITHUB_STEP_SUMMARY

    sonarqube:
        name: SonarQube
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: [build, lint, test]
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository # Skip for external forks
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Restore Node Modules Cache
              uses: actions/cache/restore@v4
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Download Unit Coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-unit
                  path: coverage/unit/

            - name: Download Visual Coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-unit-visual
                  path: coverage/unit-visual/

            - name: Run SonarQube Scan
              uses: SonarSource/sonarqube-scan-action@v4
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    status:
        name: Status
        runs-on: ubuntu-latest
        timeout-minutes: 5
        needs: [build, lint, test, architecture, sonarqube]
        if: always()
        steps:
            - name: Report Build Status
              run: |
                  echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Test: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Architecture: ${{ needs.architecture.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- SonarQube: ${{ needs.sonarqube.result }}" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ needs.build.result }}" != "success" ]] || \
                     [[ "${{ needs.lint.result }}" != "success" ]] || \
                     [[ "${{ needs.test.result }}" != "success" ]] || \
                     [[ "${{ needs.architecture.result }}" != "success" ]] || \
                     [[ "${{ needs.sonarqube.result }}" != "success" && "${{ needs.sonarqube.result }}" != "skipped" ]]; then
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "❌ Build failed!" >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "✅ All checks passed!" >> $GITHUB_STEP_SUMMARY
