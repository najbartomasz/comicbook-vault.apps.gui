#!/bin/sh

check_circular_dependencies() {
  echo "Checking for circular dependencies..."

  local output
  output=$(npm run analyze:deps --silent 2>&1)

  if echo "$output" | grep -qE "Circular dependency|âœ– Circular"; then
    echo "âŒ Circular dependencies detected! Push aborted."
    echo "$output"
    return 1
  fi

  local unexpected_skipped
  unexpected_skipped=$(echo "$output" | grep -E "^(@|[a-z])" | grep -vE "^(@angular/|vitest/|@testing/)")

  if [ -n "$unexpected_skipped" ]; then
    echo "âŒ Unexpected module resolution warnings detected! Push aborted."
    echo "$unexpected_skipped"
    return 1
  fi

  return 0
}

check_orphaned_files() {
  echo "Checking for orphaned files..."

  local output
  output=$(npm run analyze:orphans --silent)

  if echo "$output" | grep -q "Orphan modules:"; then
    echo "âŒ Orphaned files detected! Push aborted."
    echo "$output"
    return 1
  fi

  return 0
}

update_dependency_graphs() {
  local current_branch
  local remote_branch
  local structural_changes

  current_branch=$(git rev-parse --abbrev-ref HEAD)
  remote_branch="origin/$current_branch"

  if ! git rev-parse --verify "$remote_branch" >/dev/null 2>&1; then
    return 0
  fi

  structural_changes=$(git diff --name-status "$remote_branch"...HEAD | grep -E '^(A|D|R)' || true)

  if [ -z "$structural_changes" ]; then
    return 0
  fi

  echo "ğŸ“Š Structural changes detected, updating dependency graphs..."

  echo "  â†’ Module dependencies overview..."
  npm run visualize:modules --silent

  echo "  â†’ Architectural layers visualization..."
  npm run visualize:layers --silent

  if ! git diff --quiet docs/module-dependencies.svg docs/architecture-layers.svg 2>/dev/null; then
    echo "âŒ Dependency graphs have changed. Please review and commit them:"
    echo "   git add docs/module-dependencies.svg docs/architecture-layers.svg"
    echo "   git commit -m 'docs: update dependency graphs'"
    echo "   git push"
    return 1
  fi

  return 0
}



echo "ğŸ” Analyzing dependencies..."

check_circular_dependencies || exit 1
check_orphaned_files || exit 1
update_dependency_graphs

echo "âœ… All dependency checks passed!"
